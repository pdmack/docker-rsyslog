# rsyslog configuration file

# For more information see /usr/share/doc/rsyslog-*/rsyslog_conf.html
# If you experience problems, see http://www.rsyslog.com/doc/troubleshoot.html

#### GLOBAL DIRECTIVES ####

global(
    # Where to place auxiliary files
    workDirectory="/var/lib/rsyslog"
    # perf-dept: we want fully qualified domain names for common logging
    preserveFQDN="on"
    # Try to avoid any message truncation
    maxMessageSize="65536")

main_queue(
    # Beaf up the internal message queue
    queue.size="131072"
    # 90% of QueueSize
    queue.discardmark="117964"
    # If we reach the discard mark, we'll throw out notice, info, and debug messages
    queue.discardseverity="5")


#### MODULES ####

# Emit internal rsyslog counters
module(load="impstats" format="cee" interval="60")

# Read from systemd's journal
#module(load="imjournal" StateFile="imjournal.state" UsePidFromSystem="on" RateLimit.Burst="500000" RateLimit.Interval="10" IgnorePreviousMessages="on" PersistStateInterval="1000")

# Provides UDP syslog reception
module(load="imudp")
input(type="imudp" port="10514")

# Provides TCP syslog reception
module(load="imptcp")
input(type="imptcp" port="10514")

# ElasticSearch output module
module(load="omelasticsearch")

# Parsing CEE JSON messages
module(load="mmjsonparse")

# Reformating SNMP trap messages module
module(load="mmsnmptrapd")

# Ensures we have UTF-8 encoded payloads
module(load="mmutf8fix")


# Use default timestamp format
$ActionFileDefaultTemplate RSYSLOG_FileFormat


#### RULES ####

# Ensure message is a properly formatted UTF-8 sequence
action(type="mmutf8fix" mode="utf-8")

# Reformat any SNMP trap messages (legacy format required)
*.* :mmsnmptrapd:

# Parse any CEE JSON messages
action(type="mmjsonparse")

# Include templates for destination index name and for data model
$IncludeConfig /etc/rsyslog.d/10-viaq-templates.conf

# Include Pipeline metadata information
$IncludeConfig /etc/rsyslog.d/20-viaq-pipeline-metadata.conf

# Include top-level fields modifications
$IncludeConfig /etc/rsyslog.d/25-viaq-common.conf

# Include fields in systemd section
$IncludeConfig /etc/rsyslog.d/30-viaq-systemd.conf

# Include fields in rsyslog section
$IncludeConfig /etc/rsyslog.d/40-viaq-rsyslog-section.conf


# Do not log local rsyslog container logs to ES
if ($fromhost-ip == "127.0.0.1") then stop

# Index into elasticsearch directly in a hierarchical metadata namespace
action(
    type="omelasticsearch"
    server="%ES_HOST%"
    serverport="%ES_PORT%"
    template="com-redhat-rsyslog-hier"
    searchIndex="viaq-index-pattern"
    dynSearchIndex="on"
    searchType="rsyslog"
    bulkmode="on"
    queue.type="linkedlist"
    queue.size="5000"
    queue.dequeuebatchsize="300"
    action.resumeretrycount="-1")



